name: CI

on:
  workflow_dispatch:

jobs:
  guardrails:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Block pinned specs in README/story
        shell: bash
        run: |
          set -euo pipefail

          BASE_BRANCH="${GITHUB_BASE_REF:-main}"
          git fetch origin "$BASE_BRANCH" --depth=1 || true

          if git show-ref --verify --quiet "refs/remotes/origin/${BASE_BRANCH}"; then
            BASE_REF="origin/${BASE_BRANCH}"
          else
            BASE_REF="$(git rev-parse HEAD^ || echo HEAD)"
          fi

          PATTERN='\b(?:Llama|MiniLM|Ryzen|Intel|NVIDIA|Blackwell|Strix|Halo|Xeon|GN100|GPU|CPU|CUDA|cuDNN)\b|\b\d+(?:\.\d+)?\s*(?:W|dB|dBA|GHz|GB|TB|TOPS|cm|mm|L)\b|\b\d+\s*-\s*\d+\s*B\b'

          ADDED=$(git diff --unified=0 "${BASE_REF}"...HEAD -- README.md blueprint/docs/goni-story.md blueprint/docs/goni-whitepaper.md \
            | grep '^+' \
            | grep -Ev '^\+\+\+|^@@' \
            | grep -E "$PATTERN" || true)

          if [ -n "$ADDED" ]; then
            echo "Blocked: new pinned specs detected in README/story/whitepaper. Keep concrete numbers in decisions or prototype tracks."
            echo "$ADDED"
            exit 1
          fi

  rust:
    needs: guardrails
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: blueprint/software/kernel
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          components: clippy
          override: true
      - name: Cargo check
        run: cargo check --workspace
      - name: Cargo test
        run: cargo test --workspace --all-features
      - name: Cargo clippy
        run: cargo clippy --workspace --all-features -- -D warnings

  meta:
    needs: guardrails
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate truth map
        run: python blueprint/scripts/validate_truth_map.py
      - name: Generate agents
        run: python blueprint/scripts/generate_agents.py
      - name: Ensure no diff
        run: git diff --exit-code
      - name: TXT lint
        run: bash blueprint/scripts/txt_lint.sh

  bench_smoke:
    needs: guardrails
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Bench smoke
        run: python blueprint/goni-lab/goni_lab.py bench --scenario blueprint/goni-lab/scenarios/mixed.json

  demo_smoke:
    needs: rust
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: blueprint/software/kernel
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          components: clippy
          override: true
      - name: Smoke test (local)
        run: bash ../../scripts/run_smoke_local.sh
